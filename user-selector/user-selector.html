<template>
  <style type="text/css">
    ul, li {
      margin: 0;
      padding: 0;
      list-style: none;
    }
    .selected-box li {
      color: #fff;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px 10px 0 0;
      padding: 6px 12px;
      display: inline-block;
      background-color: #0f5ffd;
    }
    .selected-box li:hover {
      background-color: #3B78F1;
    }
    .result-panel {
      position: relative;
      padding-left: 1px;
    }
    .result-list {
      min-width: 310px;
      z-index: 999;
      margin-left: -2px;
      position: absolute;
      background-color: #fff;
      border: 1px solid #ddd;
      display: none;
    }
    .result-list li {
      padding: 7px 12px;
      border-bottom: 1px solid #ddd
    }
    .result-list li.selected {
      color: #fff;
      background-color: #0f5ffd;
    }
  </style>
  
  <content></content>
  <div class="result-panel">
    <ul class="result-list"></ul>
  </div>
  <ul class="selected-box"></ul>
</template>

<script>
(function() {

  var element = Object.create(HTMLElement.prototype);
  var template = document.currentScript.ownerDocument.querySelector('template').content;

  element.attachedCallback = function() {
    // create shadow root
    var shadowRoot = this.createShadowRoot();
    var clone = document.importNode(template, true);
    shadowRoot.appendChild(clone);

    // elements
    this.input = this.querySelectorAll('input')[0];
    this.resultList = shadowRoot.querySelectorAll('.result-list')[0];
    this.selectedBox = shadowRoot.querySelectorAll('.selected-box')[0];

    // property
    this.max = 5;
    this.index = 0;
    this.value = [];
    this.url = this.getAttribute('data-url');
    this.users = JSON.parse(this.getAttribute('data-users') || '[]');

    // default value
    var defaultValues = JSON.parse(this.getAttribute('data-value') || '[]');
    defaultValues.forEach(this.userSelected.bind(this));

    // bind event
    this.bindEvent();
  };

  element.userSelected = function(user) {
    var li = document.createElement('li');
    li.innerHTML = user.lastName + '(' + user.name + ') <b>x</b>';
    this.selectedBox.appendChild(li);
    this.input.value = '';
    this.value.push(user);
  };

  element.getUser = function(id) {
    var result = {};
    this.users.forEach(function(user) {
      if(user.id == id) {
        result = user;
      }
    });
    return result;
  };
  element.setUsers = function(users) {
    this.users = users;
  };

  element.search = function(keyword) {
    if(!keyword) return;

    if(this.url) {
      var xhr = new XMLHttpRequest()
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4 && xhr.status == 200) {
          this.users = JSON.parse(xhr.responseText).users;
          this.count = this.users.length > this.max ? this.max : this.users.length;
          this.index = 0;
          this.renderPanel(this.users);
          this.showPanel();
        }
      }.bind(this)
      var url = this.url + '/?keyword=' + encodeURIComponent(keyword);
      xhr.open("GET", url, true);
      xhr.send();
    } else {
      var results = this.users.filter(function(user) {
        if(user.id.toLowerCase().indexOf(keyword.toLowerCase()) > -1 || 
          user.name.toLowerCase().indexOf(keyword.toLowerCase()) > -1 || 
          user.lastName.toLowerCase().indexOf(keyword.toLowerCase()) > -1) {
          return true;
        } else {
          return false;
        }
      });

      if(results.length) {
        this.count = results.length > this.max ? this.max : results.length;
        this.index = 0;
        this.renderPanel(results);
        this.showPanel();
      } else {
        this.hidePanel();
      }
    }
  };
  element.renderPanel = function(users) {
    var html = '';
    users.forEach(function(user, i) {
      if(i >= this.max) return;
      html += '<li data-user-id="' + user.id + '">' + user.name + '</li>';
    }.bind(this));
    this.resultList.innerHTML = html;
  };

  element.bindEvent = function() {
    this.input.addEventListener('blur', function() {
      this.isFocusing = false;
      this.hidePanel();
    }.bind(this));

    this.input.addEventListener('focus', function() {
      this.isFocusing = true;
    }.bind(this));
    
    this.input.addEventListener('keydown', function(e) {
      if(e.keyCode === 13){
        e.preventDefault();
      }
    });

    this.input.addEventListener('keyup', function(e) {
      if(!e.target.value.trim()) {
        this.hidePanel();
        return;
      }
      if(e.keyCode === 38) {
        this.up();
      }else if(e.keyCode === 40) {
        this.down();
      }else if(e.keyCode === 13){
        var elm = this.resultList.querySelectorAll('.selected');
        if(!elm.length) return;
        var userId = elm[0].getAttribute('data-user-id');
        this.userSelected(this.getUser(userId));
        this.hidePanel();
        e.preventDefault();
      }else{
        this.search(e.target.value);
      }
    }.bind(this));
  };

  element.up = function() {
    if(this.index > 1){
      this.index--;
    }else{
      this.index = this.count;
    }
    if(this.selectedElm) {
      this.selectedElm.className = '';
    }
    this.selectedElm = this.resultList.querySelectorAll('li')[this.index-1];
    this.selectedElm.className = 'selected';
  };
  element.down = function() {
    if(this.index < this.count){
      this.index++;
    }else{
      this.index = 1;
    }
    if(this.selectedElm) {
      this.selectedElm.className = '';
    }
    this.selectedElm = this.resultList.querySelectorAll('li')[this.index-1];
    this.selectedElm.className = 'selected';
  };

  element.hidePanel = function() {
    this.index = 0;
    this.resultList.style.display = 'none';
  };
  element.showPanel = function() {
    this.resultList.style.display = 'block';
  };
  
  document.registerElement('user-selector', {
    prototype: element
  });

})();
</script>